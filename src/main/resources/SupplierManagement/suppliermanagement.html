<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Supplier & Supply Management</title>
    <!-- Bootstrap CSS CDN for responsive and friendly UI -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 2rem;
        }
        .form-section {
            margin-bottom: 2rem;
        }
        table {
            font-size: 1rem;
        }
    </style>
</head>
<body>
<div class="container">
    <h1 class="mb-4">Supplier Management</h1>

    <!-- Add New Supplier Form -->
    <div class="form-section">
        <h2>Add New Supplier</h2>
        <form id="addSupplierForm">
            <div class="mb-3">
                <label for="supplierName" class="form-label">Name</label>
                <input type="text" class="form-control" id="supplierName" required>
            </div>
            <div class="mb-3">
                <label for="phoneNumber" class="form-label">Phone Number</label>
                <input type="text" class="form-control" id="phoneNumber" required>
            </div>
            <div class="mb-3">
                <label for="supplierAddress" class="form-label">Address</label>
                <input type="text" class="form-control" id="supplierAddress" required>
            </div>
            <button type="submit" class="btn btn-primary">Add Supplier</button>
        </form>
    </div>

    <!-- Suppliers List -->
    <div class="table-responsive form-section">
        <h2>Supplier List</h2>
        <table class="table table-bordered table-hover" id="supplierTable">
            <thead class="table-light">
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Phone Number</th>
                <th>Address</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <!-- Suppliers data will be populated here -->
            </tbody>
        </table>
    </div>

    <!-- Update Supplier Form (hidden by default) -->
    <div class="form-section" id="updateSupplierSection" style="display: none;">
        <h2>Update Supplier Information</h2>
        <form id="updateSupplierForm">
            <!-- Save original phone identifier -->
            <input type="hidden" id="originalSupplierPhone">
            <div class="mb-3">
                <label for="updateSupplierName" class="form-label">Name</label>
                <input type="text" class="form-control" id="updateSupplierName" required>
            </div>
            <div class="mb-3">
                <label for="updatePhoneNumber" class="form-label">Phone Number</label>
                <input type="text" class="form-control" id="updatePhoneNumber" required>
            </div>
            <div class="mb-3">
                <label for="updateSupplierAddress" class="form-label">Address</label>
                <input type="text" class="form-control" id="updateSupplierAddress" required>
            </div>
            <div class="mb-3">
                <label for="updateSupplierStatus" class="form-label">Status</label>
                <select class="form-select" id="updateSupplierStatus">
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Update Supplier</button>
            <button type="button" class="btn btn-secondary" id="cancelUpdate">Cancel</button>
        </form>
    </div>

    <hr>

    <h1 class="mb-4">Supply Records</h1>

    <!-- Add New Supply Record Form -->
    <div class="form-section">
        <h2>Add New Supply Record</h2>
        <form id="addSupplyForm">
            <div class="mb-3">
                <label for="supplySupplierPhone" class="form-label">Supplier Phone</label>
                <input type="text" class="form-control" id="supplySupplierPhone" required>
            </div>
            <div class="mb-3">
                <label for="supplyProductId" class="form-label">Product ID</label>
                <input type="number" class="form-control" id="supplyProductId" required>
            </div>
            <div class="mb-3">
                <label for="supplyStock" class="form-label">Supply Stock</label>
                <input type="number" class="form-control" id="supplyStock" required>
            </div>
            <div class="mb-3">
                <label for="deliveryAddress" class="form-label">Delivery Address</label>
                <input type="text" class="form-control" id="deliveryAddress" required>
            </div>
            <button type="submit" class="btn btn-primary">Add Supply Record</button>
        </form>
    </div>

    <!-- Supply List -->
    <div class="table-responsive form-section">
        <h2>Supply List</h2>
        <table class="table table-bordered table-hover" id="supplyTable">
            <thead class="table-light">
            <tr>
                <th>ID</th>
                <th>Supplier Phone</th>
                <th>Product ID</th>
                <th>Supply Stock</th>
                <th>Delivery Address</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <!-- Supply records data will be populated here -->
            </tbody>
        </table>
    </div>

    <!-- Update Supply Record Form (hidden by default) -->
    <div class="form-section" id="updateSupplySection" style="display: none;">
        <h2>Update Supply Record</h2>
        <form id="updateSupplyForm">
            <input type="hidden" id="updateSupplyId">
            <div class="mb-3">
                <label for="updateSupplySupplierPhone" class="form-label">Supplier Phone</label>
                <input type="text" class="form-control" id="updateSupplySupplierPhone" required>
            </div>
            <div class="mb-3">
                <label for="updateSupplyProductId" class="form-label">Product ID</label>
                <input type="number" class="form-control" id="updateSupplyProductId" required>
            </div>
            <div class="mb-3">
                <label for="updateSupplyStock" class="form-label">Supply Stock</label>
                <input type="number" class="form-control" id="updateSupplyStock" required>
            </div>
            <div class="mb-3">
                <label for="updateDeliveryAddress" class="form-label">Delivery Address</label>
                <input type="text" class="form-control" id="updateDeliveryAddress" required>
            </div>
            <button type="submit" class="btn btn-primary">Update Supply Record</button>
            <button type="button" class="btn btn-secondary" id="cancelSupplyUpdate">Cancel</button>
        </form>
    </div>
</div>

<!-- Bootstrap Bundle JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- JavaScript to handle AJAX calls and form submissions -->
<script>
    // ---------- Suppliers Section ----------
    async function loadSuppliers() {
        try {
            const response = await fetch('/suppliers');
            if (!response.ok) throw new Error('Failed to load suppliers');
            const suppliers = await response.json();
            renderSupplierTable(suppliers);
        } catch (e) {
            console.error(e);
        }
    }

    function renderSupplierTable(suppliers) {
        const tableBody = document.querySelector("#supplierTable tbody");
        tableBody.innerHTML = '';
        suppliers.forEach(supplier => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                    <td>${supplier.id}</td>
                    <td>${supplier.name}</td>
                    <td>${supplier.phoneNumber}</td>
                    <td>${supplier.address}</td>
                    <td>${supplier.active ? 'Active' : 'Inactive'}</td>
                    <td>
                        <button class="btn btn-warning btn-sm update-btn" data-phone="${supplier.phoneNumber}">Update</button>
                        ${!supplier.active ? <button class="btn btn-danger btn-sm delete-btn" data-phone="${supplier.phoneNumber}">Delete</button> : ''}
                    </td>
                `;
            tableBody.appendChild(tr);
        });
    }

    document.getElementById("addSupplierForm").addEventListener("submit", async function(e) {
        e.preventDefault();
        const supplier = {
            name: document.getElementById("supplierName").value,
            phoneNumber: document.getElementById("phoneNumber").value,
            address: document.getElementById("supplierAddress").value,
            active: true
        };
        try {
            const response = await fetch('/suppliers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(supplier)
            });
            if (!response.ok) throw new Error('Could not add supplier');
            await loadSuppliers();
            e.target.reset();
        } catch(e) {
            console.error(e);
        }
    });

    // Handle supplier table actions (update/delete)
    document.querySelector("#supplierTable tbody").addEventListener("click", async function(e) {
        // Update supplier
        if (e.target.classList.contains("update-btn")) {
            const phone = e.target.getAttribute("data-phone");
            try {
                const response = await fetch(/suppliers/${phone});
                if (!response.ok) throw new Error('Supplier not found');
                const supplier = await response.json();
                document.getElementById("originalSupplierPhone").value = supplier.phoneNumber;
                document.getElementById("updateSupplierName").value = supplier.name;
                document.getElementById("updatePhoneNumber").value = supplier.phoneNumber;
                document.getElementById("updateSupplierAddress").value = supplier.address;
                document.getElementById("updateSupplierStatus").value = supplier.active;
                document.getElementById("updateSupplierSection").style.display = "block";
            } catch (err) {
                console.error(err);
            }
        }
        // Delete supplier (only inactive)
        if (e.target.classList.contains("delete-btn")) {
            const phone = e.target.getAttribute("data-phone");
            if (confirm("Are you sure you want to delete this inactive supplier?")) {
                try {
                    const response = await fetch(/suppliers/${phone}, { method: 'DELETE' });
                    if (!response.ok) throw new Error('Failed to delete supplier');
                    await loadSuppliers();
                } catch (err) {
                    console.error(err);
                }
            }
        }
    });

    document.getElementById("updateSupplierForm").addEventListener("submit", async function(e) {
        e.preventDefault();
        const originalPhone = document.getElementById("originalSupplierPhone").value;
        const updatedSupplier = {
            name: document.getElementById("updateSupplierName").value,
            phoneNumber: document.getElementById("updatePhoneNumber").value,
            address: document.getElementById("updateSupplierAddress").value,
            active: document.getElementById("updateSupplierStatus").value === "true"
        };
        try {
            const response = await fetch(/suppliers/${originalPhone}, {
                method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedSupplier)
            });
            if (!response.ok) throw new Error('Failed to update supplier');
            await loadSuppliers();
            document.getElementById("updateSupplierSection").style.display = "none";
        } catch (err) {
            console.error(err);
        }
    });

    document.getElementById("cancelUpdate").addEventListener("click", function() {
        document.getElementById("updateSupplierSection").style.display = "none";
    });

    // ---------- Supply Records Section ----------
    async function loadSupplies() {
        try {
            const response = await fetch('/api/supplies');
            if (!response.ok) throw new Error('Failed to load supplies');
            const supplies = await response.json();
            renderSupplyTable(supplies);
        } catch (e) {
            console.error(e);
        }
    }

    function renderSupplyTable(supplies) {
        const tableBody = document.querySelector("#supplyTable tbody");
        tableBody.innerHTML = '';
        supplies.forEach(supply => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                    <td>${supply.id}</td>
                    <td>${supply.supplier.phoneNumber}</td>
                    <td>${supply.product.id}</td>
                    <td>${supply.supplyStock}</td>
                    <td>${supply.deliveryAddress}</td>
                    <td>
                        <button class="btn btn-warning btn-sm supply-update-btn" data-id="${supply.id}">Update</button>
                        <button class="btn btn-danger btn-sm supply-delete-btn" data-id="${supply.id}">Delete</button>
                    </td>
                `;
            tableBody.appendChild(tr);
        });
    }

    document.getElementById("addSupplyForm").addEventListener("submit", async function(e) {
        e.preventDefault();
        const supply = {
            supplier: { phoneNumber: document.getElementById("supplySupplierPhone").value },
            product: { id: parseInt(document.getElementById("supplyProductId").value) },
            supplyStock: parseInt(document.getElementById("supplyStock").value),
            deliveryAddress: document.getElementById("deliveryAddress").value
        };
        try {
            const response = await fetch('/api/supplies', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(supply)
            });
            if (!response.ok) throw new Error('Failed to add supply record');
            await loadSupplies();
            e.target.reset();
        } catch (err) {
            console.error(err);
        }
    });

    // Handle supply table actions (update/delete)
    document.querySelector("#supplyTable tbody").addEventListener("click", async function(e) {
        // Update supply record
        if (e.target.classList.contains("supply-update-btn")) {
            const id = e.target.getAttribute("data-id");
            try {
                const response = await fetch(/api/supplies/${id});
                if (!response.ok) throw new Error('Supply record not found');
                const supply = await response.json();
                document.getElementById("updateSupplyId").value = supply.id;
                document.getElementById("updateSupplySupplierPhone").value = supply.supplier.phoneNumber;
                document.getElementById("updateSupplyProductId").value = supply.product.id;
                document.getElementById("updateSupplyStock").value = supply.supplyStock;
                document.getElementById("updateDeliveryAddress").value = supply.deliveryAddress;
                document.getElementById("updateSupplySection").style.display = "block";
            } catch (err) {
                console.error(err);
            }
        }
        // Delete supply record
        if (e.target.classList.contains("supply-delete-btn")) {
            const id = e.target.getAttribute("data-id");
            if (confirm("Are you sure you want to delete this supply record?")) {
                try {
                    const response = await fetch(/api/supplies/${id}, { method: 'DELETE' });
                    if (!response.ok) throw new Error('Failed to delete supply record');
                    await loadSupplies();
                } catch (err) {
                    console.error(err);
                }
            }
        }
    });

    document.getElementById("updateSupplyForm").addEventListener("submit", async function(e) {
        e.preventDefault();
        const id = document.getElementById("updateSupplyId").value;
        const updatedSupply = {
            supplier: { phoneNumber: document.getElementById("updateSupplySupplierPhone").value },
            product: { id: parseInt(document.getElementById("updateSupplyProductId").value) },
            supplyStock: parseInt(document.getElementById("updateSupplyStock").value),
            deliveryAddress: document.getElementById("updateDeliveryAddress").value
        };
        try {
            const response = await fetch(/api/supplies/${id}, {
                method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedSupply)
            });
            if (!response.ok) throw new Error('Failed to update supply record');
            await loadSupplies();
            document.getElementById("updateSupplySection").style.display = "none";
        } catch (err) {
            console.error(err);
        }
    });

    document.getElementById("cancelSupplyUpdate").addEventListener("click", function() {
        document.getElementById("updateSupplySection").style.display = "none";
    });

    // Initial load of data from backend
    loadSuppliers();
    loadSupplies();
</script>
</body>
</html>